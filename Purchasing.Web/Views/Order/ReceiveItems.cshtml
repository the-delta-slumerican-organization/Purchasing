@model OrderReceiveModel


@{
    ViewBag.Title = "Receive Items";
    ViewBag.HideEditDialogue = true;
}

@section SubNav
{
    <ul class="navigation">
        <li><a href="@Url.Action("Review", new {id=Model.OrderId})" class="ui-button button ui-state-default">Back to Order</a></li>
    </ul>
}

@section AdditionalScripts
{
    <style type="text/css">
        .navigation li{ display:inline-block; width:auto; padding:0 0 0 10px;}
        #orn {margin: 1em 0;}
        #orn ul {padding: 0;}
        #orn li {margin: 0;}
        #order-details .col1, #order-details .col2, #kfs-section .col1, #kfs-section .col2 {width: 49.25%; vertical-align: top; text-align: left; display:inline-block;}
        #kfs-section .col1 {margin-top:36px; padding-left:30px; width:46%;}
        #order-details .col1 .display-form, #order-details .col2 .display-form {height: 140px; margin-bottom: 0;}
        #order-details .col1 ul {padding:50px 0 0 30px;}
        #order-details .col1 ul span, #accounts .acct-info span, #order-details .col1 ul strong, #accounts .acct-info strong, #kfs .col1 ul span  {display:inline-block; vertical-align:top;}
        #order-details .col1 ul span, #kfs .col1 ul span, #kfs .col2 ul span {width:150px;}
        #accounts .acct-info span  {width:auto; min-width:650px;}
        #order-details .col1 ul strong {width:250px;}
        #accounts .acct-info strong  {width:150px;}
        
        #order-details .col2 section#vendor {margin-bottom:20px;}
        
        .item-footer {background-color:#FFF; color: #000; }
        .item-footer .label {text-align: right;}
        
        .extra-info .line-url, .extra-info .line-notes {display:inline-block; width: 49%; text-align: left;}
        .extra-info .line-url {margin-right: 10px;}
        
        .row-even {background-color:#EEEEEE;}
        .row-odd {}
        .row-split {width: 400px; border: 1px solid lightgray; background-color: lightgreen;}
        .row-split-prob {background-color: lightcoral;}
        .row-split table {border: none;}
        .row-total-value, .row-total-grandtotal {font-weight:bold;}
        .row-total-label, .row-total-value {background-color:#014A81; color:#FFFFFF;}
        #history table, #notes table, #approvals table { border: none; }
        #history table tr, #notes table tr, #approvals table tr {border-bottom: 1px solid lightgray;}
        #history table tr > td:first-child, #notes table tr > td:first-child, #approvals table tr > td:first-child { width: 150px;}
        #history table tr > td:last-child, #notes table tr > td:last-child #approvals table tr > td:last-child { width: 150px;}
        
        .acct-info .account, .acct-info .subaccount, .acct-info .project {margin-right: 20px;}
        
        .approval-complete { background-color: #dafcc9;}
        
        .row-bottom {border-bottom:1px solid #666;}
        
        form section ul, .display-form ul {padding:0;}
        #accounts .section-contents, #attachments .section-contents, #notes .section-contents, .vcard {font-size:1.2em; line-height:2.5em;}
    </style>



    <script type="text/javascript">

        $(function () {
            $(".receiveLineItem").change(function () {
                var receiveVal = $(this).val();

                if (!$.isNumeric(receiveVal)) {
                    alert("Must be a number");
                } else {
                    var lineItemId = $(this).data("id");
                    var id = $("#id").val();
                    var antiforgery = $("input[name='__RequestVerificationToken']").val();
                    var url = '@Url.Action("ReceiveItems")';
                    var line = "#receivedLineItem_" + lineItemId;
                    var loaderId = "#loader-image" + lineItemId;
                    var updateMessage = "#updateMessage" + lineItemId;
                    $(updateMessage).html("Updateing...");
                    $(loaderId).toggle();
                    $.post(url, { id: id, lineItemId: lineItemId, receivedQuantity: receiveVal, __RequestVerificationToken: antiforgery }, function (result) {
                        $(loaderId).toggle();
                        if (result) {
                            $(line).val(result.receivedQuantityReturned);
                            if (result.success == true) {
                                $(updateMessage).html(result.message);
                            } else {
                                $(updateMessage).html(result.message);
                            }
                        } else {
                            alert("There was a problem updated the received quantity.");
                        }

                    });
                }
            });
        });
    </script>
}

@Html.Partial("_ReviewOrderDetails", Model.ReviewOrderViewModel)


<section id="line-items" class="ui-corner-all display-form">

    <header class="ui-corner-top ui-widget-header">Line Items</header>

    <div class="section-contents">

        @Html.Hidden("id", Model.OrderId)
        @Html.AntiForgeryToken()

        <table class="no-icon-table">
            <thead>
                <tr>
                    <th>Receive Qty</th>
                    <th>Ordered Qty</th>
                    <th>Outstanding</th>
                    <th>Unit</th>
                    <th>Catalog #</th>
                    <th>Description</th>
                    <th>Commodity</th>
                    <th>Unit $</th>
                </tr>
            </thead>
            <tbody>
                @{
                    var odd = false;
                    var lineId = "";
                    var spanId = "";
                    var loaderId = "";
                }
                @foreach(var item in Model.LineItems)
                {
                    lineId = "receivedLineItem_" + item.Id;
                    spanId = "updateMessage" + item.Id;
                    loaderId = "loader-image" + item.Id;
                    <tr class="@(odd ? "odd":"even")">               
                        <td class="receiveLineItemCell"><input class="receiveLineItem" data-id="@item.Id" title="Number of Units received for this line item." value="@item.QuantityReceived" id="@lineId"/><span id="@loaderId" style="display: none;"><img src='@Url.Image("ajax-loader.gif")'/></span><span id="@spanId"></span></td>
                        <td>@item.Quantity</td>
                        <td class="red bold">(5)</td>
                        <td>@item.Unit</td>
                        <td>@(string.IsNullOrWhiteSpace(item.CatalogNumber) ? "n/a" : item.CatalogNumber)</td>
                        <td>@item.Description</td>
                        <td>@(item.Commodity != null ? item.Commodity.Name : "n/a")</td>
                        <td>@item.UnitPrice</td>
                    </tr>
                    odd = !odd;
                }
            </tbody>
        </table>

    </div>


</section>

